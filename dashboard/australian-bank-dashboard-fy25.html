<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Australian Banking FY25 Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0a0e17;
  --bg-card: #111827;
  --bg-card-hover: #1a2235;
  --border: #1e293b;
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --accent-gold: #f59e0b;
  --cba: #FFD700;
  --nab: #E63946;
  --anz: #3B82F6;
  --wbc: #D5002B;
  --mqg: #DADADA;
  --positive: #10b981;
  --negative: #ef4444;
  --gradient-start: #0a0e17;
  --gradient-end: #111827;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html {
  scroll-behavior: smooth;
  scroll-snap-type: y proximity;
}

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

.noise-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 1000;
}

/* === HERO SECTION === */
.hero {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 2rem;
  position: relative;
  scroll-snap-align: start;
  overflow: hidden;
}

#globe-canvas {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 0;
  pointer-events: none;
}

.hero-glass {
  position: relative;
  z-index: 2;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  padding: 2.5rem 2rem;
  border-radius: 24px;
  background: rgba(10, 14, 23, 0.00);
  backdrop-filter: blur(3px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.06);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.04);
  max-width: 640px;
  width: calc(100% - 2rem);
}

.hero::before {
  content: '';
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  background: radial-gradient(ellipse at 30% 20%, rgba(245,158,11,0.06) 0%, transparent 60%),
              radial-gradient(ellipse at 70% 80%, rgba(59,130,246,0.04) 0%, transparent 60%);
}

.hero-tag {
  font-size: 0.75rem;
  letter-spacing: 0.3em;
  text-transform: uppercase;
  color: var(--accent-gold);
  margin-bottom: 1.5rem;
  opacity: 0;
  animation: fadeUp 0.8s ease 0.2s forwards;
  position: relative;
  z-index: 2;
}

.hero h1 {
  font-family: 'Playfair Display', serif;
  font-size: clamp(2.5rem, 6vw, 5rem);
  font-weight: 700;
  line-height: 1.1;
  letter-spacing: -0.02em;
  margin-bottom: 1rem;
  opacity: 0;
  animation: fadeUp 0.8s ease 0.4s forwards;
  position: relative;
  z-index: 2;
}

.hero h1 span {
  background: linear-gradient(135deg, var(--accent-gold), #fbbf24);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.8))
          drop-shadow(0 0 20px rgba(0, 0, 0, 0.5));
}

.hero-subtitle {
  font-size: 1.1rem;
  color: var(--text-secondary);
  max-width: 600px;
  line-height: 1.6;
  opacity: 0;
  animation: fadeUp 0.8s ease 0.6s forwards;
  position: relative;
  z-index: 2;
}

.hero-banks {
  display: flex;
  gap: 1.5rem;
  margin-top: 3rem;
  flex-wrap: wrap;
  justify-content: center;
  opacity: 0;
  animation: fadeUp 0.8s ease 0.8s forwards;
  position: relative;
  z-index: 2;
}

.bank-pill {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 2rem;
  font-size: 0.85rem;
  font-weight: 500;
  transition: all 0.3s ease;
}

.bank-pill:hover {
  transform: translateY(-2px);
  border-color: var(--text-muted);
}

.bank-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
}

.scroll-indicator {
  position: absolute;
  bottom: 2rem;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  color: var(--text-muted);
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  opacity: 0;
  animation: fadeUp 0.8s ease 1s forwards;
  z-index: 2;
}

.scroll-arrow {
  width: 20px; height: 30px;
  border: 1.5px solid var(--text-muted);
  border-radius: 10px;
  position: relative;
}

.scroll-arrow::after {
  content: '';
  width: 3px; height: 6px;
  background: var(--text-muted);
  border-radius: 2px;
  position: absolute;
  top: 6px; left: 50%;
  transform: translateX(-50%);
  animation: scrollBounce 1.5s ease infinite;
}

/* === SECTIONS === */
.section {
  min-height: 100vh;
  padding: 4rem 1.5rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  scroll-snap-align: start;
  position: relative;
}

.section-header {
  text-align: center;
  margin-bottom: 3rem;
  max-width: 700px;
}

.section-tag {
  font-size: 0.7rem;
  letter-spacing: 0.3em;
  text-transform: uppercase;
  color: var(--accent-gold);
  margin-bottom: 0.75rem;
}

.section-header h2 {
  font-family: 'Playfair Display', serif;
  font-size: clamp(1.8rem, 4vw, 2.8rem);
  font-weight: 600;
  margin-bottom: 0.75rem;
}

.section-header p {
  color: var(--text-secondary);
  line-height: 1.6;
  font-size: 0.95rem;
}

/* === VIEW TOGGLE ICONS === */
.view-toggle {
  display: flex;
  gap: 0.75rem;
  justify-content: center;
  margin-bottom: 2rem;
}

.view-icon {
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  color: var(--text-muted);
}

.view-icon svg {
  width: 20px;
  height: 20px;
}

.view-icon:hover {
  border-color: var(--accent-gold);
  transform: translateY(-2px);
}

.view-icon.active {
  background: var(--accent-gold);
  border-color: var(--accent-gold);
  box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
  color: #0a0e17;
}

/* === KPI CARDS === */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  width: 100%;
  max-width: 1200px;
  margin-bottom: 3rem;
}

.kpi-grid.hidden { display: none; }

.kpi-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 1.5rem;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  display: flex;
  gap: 1rem;
  align-items: center;
}

.kpi-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 3px;
  background: linear-gradient(90deg, var(--accent-gold), transparent);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.kpi-card:hover {
  border-color: var(--text-muted);
  transform: translateY(-2px);
}

.kpi-card:hover::before { opacity: 1; }

.kpi-left {
  flex: 1;
  min-width: 0;
}

.kpi-right {
  flex: 1;
  display: flex;
  align-items: center;
  min-width: 0;
}

.kpi-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
}

.kpi-value {
  font-family: 'Playfair Display', serif;
  font-size: 2rem;
  font-weight: 700;
  line-height: 1;
}

.kpi-bank {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-top: 0.25rem;
}

.kpi-subtitle {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-top: 0.5rem;
  line-height: 1.4;
  white-space: normal;
  word-wrap: break-word;
}

/* === MINI BAR CHART === */
.mini-bar-chart {
  display: flex;
  flex-direction: column;
  width: 100%;
}

.mini-bar-row {
  display: flex;
  align-items: center;
  cursor: pointer;
  padding: 0;
  margin-bottom: 1rem;
  transition: opacity 0.2s ease;
}

.mini-bar-row:last-child {
  margin-bottom: 0;
}

.mini-bar-row:hover {
  opacity: 0.8;
}

.mini-bar-row.selected .mini-bar-fill {
  box-shadow: 0 0 10px currentColor;
}

.mini-bar-track {
  width: 100%;
  height: 6px;
  background: rgba(255,255,255,0.05);
  border-radius: 3px;
  position: relative;
  overflow: hidden;
}

.mini-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: all 0.3s ease;
  position: relative;
}

/* === CHART CONTAINERS === */
.chart-container {
  width: 100%;
  max-width: 1200px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 2rem;
  margin-bottom: 2rem;
  position: relative;
  overflow: hidden;
}

.chart-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.3rem;
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.chart-subtitle {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-bottom: 1.5rem;
}

.chart-area {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.chart-area svg {
  display: block;
}

/* === LEGEND === */
.legend {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 2rem;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.8rem;
  color: var(--text-secondary);
}

.legend-swatch {
  width: 12px; height: 12px;
  border-radius: 3px;
}

/* === COMMENTARY === */
.commentary {
  width: 100%;
  max-width: 1200px;
  margin-top: 2rem;
}

.commentary-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 1.5rem 2rem;
  margin-bottom: 1rem;
  border-left: 3px solid var(--accent-gold);
}

.commentary-card h4 {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--text-primary);
}

.commentary-card p {
  font-size: 0.95rem;
  color: var(--text-secondary);
  line-height: 1.7;
}

/* === TABLE === */
.data-table-wrap {
  width: 100%;
  max-width: 1000px;
  overflow-x: auto;
  margin-top: 2rem;
  -webkit-overflow-scrolling: touch;
}

.data-table-wrap.hidden { display: none; }

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 1rem;
}

thead th {
  text-align: left;
  padding: 0.85rem 1rem;
  font-size: 0.8rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-muted);
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}

tbody td {
  padding: 1rem 1rem;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}

tbody tr {
  transition: background 0.2s ease;
}

tbody tr:hover {
  background: var(--bg-card-hover);
}

.bank-name-cell {
  display: flex;
  flex-direction: column;
  gap: 0.2rem;
  font-weight: 600;
}

.bank-name-row {
  display: flex;
  align-items: center;
  gap: 0.6rem;
}

.bank-fy {
  font-size: 0.7rem;
  color: var(--text-muted);
  font-weight: 400;
}

.metric-best {
  font-weight: 600;
  color: var(--accent-gold);
}

.rank-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 20px; height: 20px;
  border-radius: 50%;
  font-size: 0.65rem;
  font-weight: 700;
  background: var(--bg-primary);
  color: var(--accent-gold);
  border: 1px solid var(--accent-gold);
}

.rank-badge.top { background: var(--accent-gold); color: var(--bg-primary); }

/* === FOOTER === */
.footer {
  text-align: center;
  padding: 3rem 1.5rem;
  color: var(--text-muted);
  font-size: 0.75rem;
  border-top: 1px solid var(--border);
  max-width: 800px;
  margin: 0 auto;
  line-height: 1.8;
}

/* === D3 STYLES === */
.bar { transition: opacity 0.2s ease; }
.bar:hover { opacity: 0.85; }
.nim-bar { cursor: pointer; transition: opacity 0.2s ease, filter 0.2s ease; }
.nim-bar:hover { opacity: 0.8; filter: brightness(1.15); }
#nim-back-btn:hover { border-color: var(--accent-gold); color: var(--text-primary); transform: translateX(-2px); }
.waterfall-commentary-inline {
  margin-top: 1.5rem;
  padding: 1.25rem 1.5rem;
  background: rgba(255,255,255,0.03);
  border-left: 3px solid var(--accent-gold);
  border-radius: 0 12px 12px 0;
  font-size: 0.9rem;
  color: var(--text-secondary);
  line-height: 1.7;
}
.waterfall-commentary-inline h4 {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.4rem;
}
.axis text { fill: var(--text-muted); font-family: 'DM Sans', sans-serif; font-size: 11px; }
.axis line, .axis path { stroke: var(--border); }
.grid line { stroke: var(--border); stroke-dasharray: 2,4; }
.grid path { display: none; }

.tooltip-d3 {
  position: fixed;
  background: #1e293b;
  border: 1px solid #334155;
  border-radius: 10px;
  padding: 10px 14px;
  font-size: 0.8rem;
  color: var(--text-primary);
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s ease;
  z-index: 999;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  line-height: 1.5;
}

.tooltip-d3 .tt-bank { font-weight: 600; margin-bottom: 2px; }
.tooltip-d3 .tt-val { color: var(--accent-gold); font-weight: 600; }

/* === ANIMATIONS === */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes scrollBounce {
  0%, 100% { transform: translateX(-50%) translateY(0); }
  50% { transform: translateX(-50%) translateY(6px); }
}

/* Responsive */
@media (max-width: 640px) {
  .section { padding: 3rem 1rem; }
  .chart-container { padding: 1.25rem; border-radius: 14px; }
  .kpi-grid { grid-template-columns: 1fr; gap: 0.75rem; }
  .kpi-card {
    padding: 1rem;
    gap: 0.75rem;
  }
  .kpi-left { flex: 1.2; min-width: 0; }
  .kpi-right { flex: 0.8; min-width: 0; }
  .kpi-value { font-size: 1.5rem; }
  .mini-bar-chart { width: 100%; }
  .mini-bar-track { width: 100%; }
  .hero-banks { gap: 0.75rem; }
  .bank-pill { padding: 0.4rem 0.75rem; font-size: 0.75rem; }
  .hero-glass {
    padding: 1.75rem 1.25rem;
    border-radius: 18px;
    backdrop-filter: blur(3px);
    -webkit-backdrop-filter: blur(14px);
  }
  .commentary-card { padding: 1rem 1.25rem; }
  .commentary-card h4 { font-size: 0.95rem; }
  .commentary-card p { font-size: 0.85rem; }

  /* Compact table for mobile */
  .data-table-wrap { max-width: 100%; }
  table { font-size: 0.75rem; }
  thead th { padding: 0.6rem 0.4rem; font-size: 0.65rem; }
  tbody td { padding: 0.7rem 0.4rem; }
  .bank-name-cell { gap: 0.15rem; }
  .bank-fy { font-size: 0.65rem; }
  .bank-dot { width: 6px; height: 6px; }
}
</style>
</head>
<body>

<div class="noise-overlay"></div>
<div class="tooltip-d3" id="tooltip"></div>

<!-- HERO -->
<section class="hero" id="hero-section">
  <canvas id="globe-canvas"></canvas>
  <div class="hero-glass">
    <div class="hero-tag">Financial Year 2025 ¬∑ Annual Comparison</div>
    <h1>Australian Bank<br><span>Performance Dashboard</span></h1>
    <p class="hero-subtitle">A comprehensive comparison of key financial metrics across Australia's Big Four banks and Macquarie Group for FY25.</p>
    <div class="hero-banks">
    <div class="bank-pill"><div class="bank-dot" style="background:var(--cba)"></div>CBA</div>
    <div class="bank-pill"><div class="bank-dot" style="background:var(--nab)"></div>NAB</div>
    <div class="bank-pill"><div class="bank-dot" style="background:var(--anz)"></div>ANZ</div>
    <div class="bank-pill"><div class="bank-dot" style="background:var(--wbc)"></div>Westpac</div>
    <div class="bank-pill"><div class="bank-dot" style="background:var(--mqg)"></div>Macquarie</div>
  </div>
  </div>
  <div class="scroll-indicator">
    <div class="scroll-arrow"></div>
    Scroll to explore
  </div>
</section>

<!-- OVERVIEW -->
<section class="section" id="overview">
  <div class="section-header">
    <div class="section-tag">Overview</div>
    <h2>FY25 At a Glance</h2>
    <p>Key performance indicators showing who leads across the critical metrics that matter to investors.</p>
  </div>
  <div class="view-toggle">
    <div class="view-icon active" id="kpi-view-icon" title="Key Metrics View">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="2" y="3" width="12" height="3" rx="1.5" fill="currentColor"/>
        <rect x="2" y="8.5" width="16" height="3" rx="1.5" fill="currentColor"/>
        <rect x="2" y="14" width="8" height="3" rx="1.5" fill="currentColor"/>
      </svg>
    </div>
    <div class="view-icon" id="table-view-icon" title="Table View">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="2" y="2" width="16" height="16" rx="2" stroke="currentColor" stroke-width="1.5" fill="none"/>
        <rect x="4" y="4" width="12" height="3" rx="1" fill="currentColor"/>
        <line x1="6.5" y1="9" x2="6.5" y2="16" stroke="currentColor" stroke-width="1.5"/>
        <line x1="10.5" y1="9" x2="10.5" y2="16" stroke="currentColor" stroke-width="1.5"/>
        <line x1="14.5" y1="9" x2="14.5" y2="16" stroke="currentColor" stroke-width="1.5"/>
        <line x1="4" y1="11.5" x2="16" y2="11.5" stroke="currentColor" stroke-width="1.5"/>
        <line x1="4" y1="14.5" x2="16" y2="14.5" stroke="currentColor" stroke-width="1.5"/>
      </svg>
    </div>
  </div>
  <div class="kpi-grid" id="kpi-grid"></div>
  <div class="data-table-wrap hidden">
    <table id="summary-table"></table>
  </div>
</section>

<!-- ROE -->
<section class="section" id="roe-section">
  <div class="section-header">
    <div class="section-tag">Profitability</div>
    <h2>Return on Equity</h2>
    <p>ROE measures how effectively banks generate profit from shareholders' equity ‚Äî the ultimate measure of capital efficiency.</p>
  </div>
  <div class="chart-container">
    <div class="chart-title">FY25 Cash ROE Comparison</div>
    <div class="chart-subtitle">Cash basis, continuing operations</div>
    <div class="chart-area" id="roe-chart"></div>
  </div>
  <div class="commentary">
    <div class="commentary-card">
      <h4>üèÜ CBA Dominates with 13.5% ROE</h4>
      <p>Commonwealth Bank continues to lead the peer group with a cash ROE of 13.5%, down just 10bps from FY24. This reflects CBA's superior pricing power, scale advantages, and the highest net interest margin among the majors. The premium is even more pronounced when including franking credit benefits. NAB sits second at 11.4%, while Macquarie's diversified model delivered 11.2%. ANZ's reported 8.1% ROE was heavily distorted by $1.1bn in significant items ‚Äî excluding these, underlying returns were closer to peer levels.</p>
    </div>
  </div>
</section>

<!-- NIM -->
<section class="section" id="nim-section">
  <div class="section-header">
    <div class="section-tag">Margins</div>
    <h2>Net Interest Margin</h2>
    <p>NIM captures the spread between what banks earn on loans and pay on deposits ‚Äî the core engine of bank profitability.</p>
  </div>
  <div class="chart-container" id="nim-container" style="position:relative; overflow:hidden;">
    <div id="nim-bar-view" style="transition: opacity 0.4s ease, transform 0.4s ease;">
      <div class="chart-title" style="display:inline-flex; align-items:center; gap:0.5rem;">
        FY25 Net Interest Margin
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity:0.7; vertical-align:middle;">
          <!-- Click indicator lines -->
          <line x1="3" y1="3" x2="5.5" y2="5.5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
          <line x1="8" y1="1" x2="8" y2="4.5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
          <line x1="13" y1="3" x2="10.5" y2="5.5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
          <line x1="1" y1="8" x2="4.5" y2="8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
          <line x1="3" y1="13" x2="5.5" y2="10.5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
          <!-- Cursor pointer -->
          <path d="M7 5L7 17L10.5 13.5L12.5 18L15 17L13 12.5L18 12.5L7 5Z" fill="currentColor" opacity="0.8" stroke="currentColor" stroke-width="0.5" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="chart-subtitle">Group NIM including Treasury & Markets ¬∑ <span style="color:var(--accent-gold); font-style:italic;">Click a bar to see the YoY waterfall</span></div>
      <div class="chart-area" id="nim-chart" style="cursor:pointer;"></div>
    </div>
    <div id="nim-waterfall-view" style="display:none; opacity:0; transform:translateX(30px); transition: opacity 0.4s ease, transform 0.4s ease;">
      <div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:0.25rem;">
        <button id="nim-back-btn" style="display:inline-flex; align-items:center; gap:0.4rem; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-secondary); padding:0.4rem 0.85rem; border-radius:8px; cursor:pointer; font-size:0.8rem; font-family:'DM Sans',sans-serif; transition:all 0.2s ease;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M19 12H5M12 5l-7 7 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Back
        </button>
        <div class="chart-title" id="waterfall-title" style="margin:0;"></div>
      </div>
      <div class="chart-subtitle" id="waterfall-subtitle"></div>
      <div class="chart-area" id="nim-waterfall-chart"></div>
      <div class="waterfall-commentary-inline" id="waterfall-inline-commentary" style="display:none;">
        <h4 id="wf-inline-title"></h4>
        <p id="wf-inline-body"></p>
      </div>
    </div>
  </div>
  <div class="commentary">
    <div class="commentary-card">
      <h4>üìä CBA's Margin Premium Widens to 2.08%</h4>
      <p>CBA's NIM of 2.08% ‚Äî up 9bps from FY24 ‚Äî is the clear standout, reflecting higher earnings on capital and portfolio hedges. Westpac follows at 1.94% (down 1bp), with its core NIM at 1.81% when excluding Treasury & Markets. NAB's margin lifted 3bps to 1.74%, aided by Markets & Treasury income. ANZ's 1.55% NIM reflects the drag from intense mortgage competition and the Suncorp Bank integration diluting margins. Macquarie, as a diversified financial group, reports NIM differently ‚Äî its BFS division benefits from digital deposit strength but faces different competitive dynamics.</p>
    </div>
  </div>
</section>

<!-- COST TO INCOME -->
<section class="section" id="cti-section">
  <div class="section-header">
    <div class="section-tag">Efficiency</div>
    <h2>Cost-to-Income Ratio</h2>
    <p>Lower is better ‚Äî this ratio shows how many cents of every dollar of revenue are consumed by operating costs.</p>
  </div>
  <div class="chart-container">
    <div class="chart-title">FY25 Cost-to-Income Ratio</div>
    <div class="chart-subtitle">Lower = more efficient ¬∑ Includes notable items where reported</div>
    <div class="chart-area" id="cti-chart"></div>
  </div>
  <div class="commentary">
    <div class="commentary-card">
      <h4>‚ö° CBA Stays Leanest at 45.5% Despite Investment Surge</h4>
      <p>CBA's cost-to-income of 45.5% remains the best in class, even as it hired 2,000+ engineers and boosted investment spend by $300m to $2.3bn. NAB reported ~47% (ex-notable items), reflecting disciplined cost management despite increased investment in digital platforms. Westpac's headline 53% cost-to-income was inflated by $273m in restructuring charges for its UNITE transformation program ‚Äî excluding these, the underlying ratio was closer to 50%. ANZ's reported ratio of ~53% also included $585m in restructuring charges and ASIC settlement costs. Macquarie's compensation-to-income model makes direct comparison less meaningful, though its overall efficiency reflected the benefit of scalable fee-based revenue streams.</p>
    </div>
  </div>
</section>

<!-- CET1 -->
<section class="section" id="cet1-section">
  <div class="section-header">
    <div class="section-tag">Capital Strength</div>
    <h2>CET1 Capital Ratio</h2>
    <p>Common Equity Tier 1 ratio measures the bank's core capital buffers ‚Äî the critical safety net above APRA's minimum requirements.</p>
  </div>
  <div class="chart-container">
    <div class="chart-title">FY25 CET1 Capital Ratio vs APRA Minimum</div>
    <div class="chart-subtitle">APRA Level 2 basis ¬∑ Regulatory minimum 10.25% (shown as threshold)</div>
    <div class="chart-area" id="cet1-chart"></div>
  </div>
  <div class="commentary">
    <div class="commentary-card">
      <h4>üõ°Ô∏è All Banks Comfortably Above Regulatory Minimums</h4>
      <p>Macquarie leads with a CET1 of 12.8% (or 17.6% on a harmonised basis), reflecting its conservative approach to capital management and $9.5bn capital surplus. Westpac sits at 12.5% ‚Äî up 4bps despite a $581m buyback ‚Äî providing $3.1bn of surplus capital above its new 11.25% target. CBA is at 12.3%, NAB at 11.7%, and ANZ at 12.0% (pro-forma 12.26% after capital actions). The sector's strong capital positions provide flexibility for further buybacks and dividends, particularly as APRA phases out AT1 capital instruments from January 2027.</p>
    </div>
  </div>
</section>

<!-- FOOTER -->
<footer class="footer">
  <p><strong>Data Sources:</strong> CBA FY25 (year ended 30 Jun 2025), NAB FY25 (year ended 30 Sep 2025), ANZ FY25 (year ended 30 Sep 2025), Westpac FY25 (year ended 30 Sep 2025), Macquarie FY25 (year ended 31 Mar 2025). All metrics are on a cash/continuing operations basis unless stated. CET1 ratios are APRA Level 2.</p>
  <p style="margin-top:0.5rem">Built with D3.js & Three.js ¬∑ Dashboard designed for educational and analytical purposes only. Not financial advice.</p>
</footer>

<script>
// === DATA ===
const banks = [
  { code: 'CBA', name: 'Commonwealth Bank', color: '#FFD700', fy: 'Jun 2025' },
  { code: 'NAB', name: 'National Australia Bank', color: '#E63946', fy: 'Sep 2025' },
  { code: 'ANZ', name: 'ANZ Banking Group', color: '#3B82F6', fy: 'Sep 2025' },
  { code: 'WBC', name: 'Westpac Banking Corp', color: '#D5002B', fy: 'Sep 2025' },
  { code: 'MQG', name: 'Macquarie Group', color: '#DADADA', fy: 'Mar 2025' }
];

const metrics = {
  roe:  [13.5, 11.4, 8.1, 9.7, 11.2],
  nim:  [2.08, 1.74, 1.55, 1.94, 1.80],
  cti:  [45.5, 47.0, 53.2, 53.0, 48.5],
  cet1: [12.3, 11.7, 12.0, 12.5, 12.8],
  npat: [10252, 7091, 5787, 6990, 3715],
  dividend_yield: [4.2, 5.3, 6.2, 5.7, 3.3]
};

// === TOOLTIP ===
const tooltip = d3.select('#tooltip');

function showTip(e, html) {
  const x = e.clientX, y = e.clientY;
  tooltip.html(html).style('opacity', 1)
    .style('left', (x + 14) + 'px')
    .style('top', (y - 10) + 'px');
}
function hideTip() { tooltip.style('opacity', 0); }

// === VIEW TOGGLE ===
let selectedBankIndex = null;
const kpiViewIcon = document.getElementById('kpi-view-icon');
const tableViewIcon = document.getElementById('table-view-icon');
const kpiGrid = document.getElementById('kpi-grid');
const tableWrap = document.querySelector('.data-table-wrap');

kpiViewIcon.addEventListener('click', () => {
  kpiViewIcon.classList.add('active');
  tableViewIcon.classList.remove('active');
  kpiGrid.classList.remove('hidden');
  tableWrap.classList.add('hidden');
  selectedBankIndex = null;
  renderKPICards();
});

tableViewIcon.addEventListener('click', () => {
  tableViewIcon.classList.add('active');
  kpiViewIcon.classList.remove('active');
  tableWrap.classList.remove('hidden');
  kpiGrid.classList.add('hidden');
  selectedBankIndex = null;
});

// === KPI CARD DATA ===
const kpiDefinitions = [
  {
    title: 'Highest ROE',
    genericTitle: 'ROE',
    subtitle: 'Cash basis, continuing operations',
    key: 'roe',
    unit: '%',
    formatValue: (v) => v + '%',
    getBest: (data) => Math.max(...data)
  },
  {
    title: 'Widest Margin',
    genericTitle: 'Margin',
    subtitle: 'Group NIM including Treasury & Markets',
    key: 'nim',
    unit: '%',
    formatValue: (v) => v + '%',
    getBest: (data) => Math.max(...data)
  },
  {
    title: 'Best Efficiency',
    genericTitle: 'Efficiency',
    subtitle: 'Cost to Income',
    key: 'cti',
    unit: '%',
    formatValue: (v) => v + '%',
    getBest: (data) => Math.min(...data)
  },
  {
    title: 'Strongest Capital',
    genericTitle: 'Capital',
    subtitle: 'CET1',
    key: 'cet1',
    unit: '%',
    formatValue: (v) => v + '%',
    getBest: (data) => Math.max(...data)
  },
  {
    title: 'Largest Profit',
    genericTitle: 'Profit',
    subtitle: 'Cash NPAT',
    key: 'npat',
    unit: '',
    formatValue: (v) => '$' + (v / 1000).toFixed(1) + 'B',
    getBest: (data) => Math.max(...data)
  },
  {
    title: 'Highest Dividend',
    genericTitle: 'Dividend',
    subtitle: 'Dividend yield',
    key: 'dividend_yield',
    unit: '%',
    formatValue: (v) => v + '%',
    getBest: (data) => Math.max(...data)
  }
];

function createMiniBarChart(metricKey, metricData) {
  const max = Math.max(...metricData);

  // Create array of objects with bank index, value, and color
  const bankBars = metricData.map((value, i) => ({
    idx: i,
    value: value,
    color: banks[i].color
  }));

  // Sort by performance: descending for most metrics, ascending for CTI (lower is better)
  bankBars.sort((a, b) => metricKey === 'cti' ? a.value - b.value : b.value - a.value);

  return bankBars.map(bar => {
    const percent = (bar.value / max) * 100;
    return `
      <div class="mini-bar-row" data-bank-idx="${bar.idx}" data-metric="${metricKey}">
        <div class="mini-bar-track">
          <div class="mini-bar-fill" style="width: ${Math.max(percent, 5)}%; background: ${bar.color};"></div>
        </div>
      </div>`;
  }).join('');
}

function renderKPICards() {
  kpiGrid.innerHTML = '';

  kpiDefinitions.forEach(kpi => {
    const metricData = metrics[kpi.key];
    const bestValue = kpi.getBest(metricData);
    const displayValue = selectedBankIndex !== null
      ? kpi.formatValue(metricData[selectedBankIndex])
      : kpi.formatValue(bestValue);

    const displayBank = selectedBankIndex !== null
      ? banks[selectedBankIndex].code
      : banks[metricData.indexOf(bestValue)].code;

    const displayColor = selectedBankIndex !== null
      ? banks[selectedBankIndex].color
      : banks[metricData.indexOf(bestValue)].color;

    const displayTitle = selectedBankIndex !== null
      ? kpi.genericTitle
      : kpi.title;

    const card = document.createElement('div');
    card.className = 'kpi-card';
    card.innerHTML = `
      <div class="kpi-left">
        <div class="kpi-title">${displayTitle}</div>
        <div class="kpi-value" style="color:${displayColor}">${displayValue}</div>
        <div class="kpi-bank">${displayBank}</div>
        <div class="kpi-subtitle">${kpi.subtitle}</div>
      </div>
      <div class="kpi-right">
        <div class="mini-bar-chart">
          ${createMiniBarChart(kpi.key, metricData)}
        </div>
      </div>
    `;
    kpiGrid.appendChild(card);
  });

  // Add click handlers to mini bars
  document.querySelectorAll('.mini-bar-row').forEach(row => {
    row.addEventListener('click', (e) => {
      const bankIdx = parseInt(row.getAttribute('data-bank-idx'));

      // Toggle selection
      if (selectedBankIndex === bankIdx) {
        selectedBankIndex = null;
      } else {
        selectedBankIndex = bankIdx;
      }

      // Re-render cards with updated selection
      renderKPICards();
    });
  });

  // Highlight selected bars
  if (selectedBankIndex !== null) {
    document.querySelectorAll(`.mini-bar-row[data-bank-idx="${selectedBankIndex}"]`).forEach(row => {
      row.classList.add('selected');
    });
  }
}

renderKPICards();

// === SUMMARY TABLE ===
const table = document.getElementById('summary-table');

// Calculate best values for each metric
const bestNPAT = Math.max(...metrics.npat);
const bestROE = Math.max(...metrics.roe);
const bestNIM = Math.max(...metrics.nim);
const bestCTI = Math.min(...metrics.cti); // Lower is better
const bestCET1 = Math.max(...metrics.cet1);

table.innerHTML = `
  <thead><tr>
    <th>Bank</th><th>Cash NPAT ($m)</th><th>ROE</th><th>NIM</th><th>C/I Ratio</th><th>CET1</th>
  </tr></thead>
  <tbody>${banks.map((b,i) => {
    return `<tr>
      <td>
        <div class="bank-name-cell">
          <div class="bank-name-row">
            <div class="bank-dot" style="background:${b.color}"></div>${b.code}
          </div>
          <div class="bank-fy">${b.fy}</div>
        </div>
      </td>
      <td class="${metrics.npat[i] === bestNPAT ? 'metric-best' : ''}">${metrics.npat[i].toLocaleString()}</td>
      <td class="${metrics.roe[i] === bestROE ? 'metric-best' : ''}">${metrics.roe[i]}%</td>
      <td class="${metrics.nim[i] === bestNIM ? 'metric-best' : ''}">${metrics.nim[i]}%</td>
      <td class="${metrics.cti[i] === bestCTI ? 'metric-best' : ''}">${metrics.cti[i]}%</td>
      <td class="${metrics.cet1[i] === bestCET1 ? 'metric-best' : ''}">${metrics.cet1[i]}%</td>
    </tr>`;
  }).join('')}</tbody>`;

// === CHART BUILDER ===
function buildBarChart(containerId, data, unit, options = {}) {
  const container = document.getElementById(containerId);
  const containerWidth = container.clientWidth || 700;
  const isMobile = containerWidth < 500;

  const margin = { top: 20, right: 30, bottom: 40, left: isMobile ? 45 : 55 };
  const width = Math.max(containerWidth - margin.left - margin.right, 300);
  const height = isMobile ? 260 : 340;

  const svg = d3.select(`#${containerId}`).append('svg')
    .attr('viewBox', `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
    .attr('preserveAspectRatio', 'xMidYMid meet')
    .style('width', '100%')
    .append('g')
    .attr('transform', `translate(${margin.left},${margin.top})`);

  const x = d3.scaleBand()
    .domain(banks.map(b => b.code))
    .range([0, width])
    .padding(0.35);

  const maxVal = options.domainMax || d3.max(data) * 1.15;
  const minVal = options.domainMin !== undefined ? options.domainMin : 0;

  const y = d3.scaleLinear()
    .domain([minVal, maxVal])
    .range([height, 0]);

  // Grid
  svg.append('g').attr('class', 'grid')
    .call(d3.axisLeft(y).ticks(5).tickSize(-width).tickFormat(''));

  // Threshold line
  if (options.threshold) {
    svg.append('line')
      .attr('x1', 0).attr('x2', width)
      .attr('y1', y(options.threshold)).attr('y2', y(options.threshold))
      .attr('stroke', '#ef4444').attr('stroke-dasharray', '6,4').attr('stroke-width', 1.5);

    svg.append('text')
      .attr('x', width - 4).attr('y', y(options.threshold) - 6)
      .attr('text-anchor', 'end')
      .attr('fill', '#ef4444').attr('font-size', '10px')
      .text(`APRA Min ${options.threshold}%`);
  }

  // Bars
  svg.selectAll('.bar')
    .data(data)
    .join('rect')
    .attr('class', 'bar')
    .attr('x', (d, i) => x(banks[i].code))
    .attr('width', x.bandwidth())
    .attr('y', height)
    .attr('height', 0)
    .attr('rx', 6)
    .attr('fill', (d, i) => banks[i].color)
    .on('mousemove', (e, d) => {
      const i = data.indexOf(d);
      showTip(e, `<div class="tt-bank">${banks[i].name}</div><div class="tt-val">${d}${unit}</div>`);
    })
    .on('mouseleave', hideTip)
    .transition()
    .duration(800)
    .delay((d, i) => i * 100)
    .ease(d3.easeCubicOut)
    .attr('y', d => y(d))
    .attr('height', d => height - y(d));

  // Value labels
  svg.selectAll('.val-label')
    .data(data)
    .join('text')
    .attr('class', 'val-label')
    .attr('x', (d, i) => x(banks[i].code) + x.bandwidth() / 2)
    .attr('y', d => y(d) - 8)
    .attr('text-anchor', 'middle')
    .attr('fill', '#e2e8f0')
    .attr('font-size', isMobile ? '11px' : '13px')
    .attr('font-weight', '600')
    .attr('opacity', 0)
    .text(d => d + unit)
    .transition()
    .duration(600)
    .delay((d, i) => i * 100 + 400)
    .attr('opacity', 1);

  // Rank badges (show #1)
  const bestIdx = options.lowerBetter
    ? data.indexOf(Math.min(...data))
    : data.indexOf(Math.max(...data));

  svg.append('text')
    .attr('x', x(banks[bestIdx].code) + x.bandwidth() / 2)
    .attr('y', y(data[bestIdx]) - 24)
    .attr('text-anchor', 'middle')
    .attr('fill', '#f59e0b')
    .attr('font-size', '14px')
    .text('üëë')
    .attr('opacity', 0)
    .transition().delay(1000).duration(400).attr('opacity', 1);

  // X axis
  svg.append('g')
    .attr('class', 'axis')
    .attr('transform', `translate(0,${height})`)
    .call(d3.axisBottom(x).tickSize(0))
    .select('.domain').remove();

  // Y axis
  svg.append('g')
    .attr('class', 'axis')
    .call(d3.axisLeft(y).ticks(5).tickFormat(d => d + unit))
    .select('.domain').remove();
}

// === BUILD CHARTS ON SCROLL (Intersection Observer) ===
const chartBuilt = {};

function buildChartIfVisible(entry) {
  const id = entry.target.id;
  if (chartBuilt[id]) return;

  if (id === 'roe-chart') { buildBarChart('roe-chart', metrics.roe, '%', { domainMin: 0 }); chartBuilt[id] = true; }
  if (id === 'nim-chart') { buildNIMBarChart(); chartBuilt[id] = true; }
  if (id === 'cti-chart') { buildBarChart('cti-chart', metrics.cti, '%', { domainMin: 40, domainMax: 58, lowerBetter: true }); chartBuilt[id] = true; }
  if (id === 'cet1-chart') { buildBarChart('cet1-chart', metrics.cet1, '%', { domainMin: 10, domainMax: 14, threshold: 10.25 }); chartBuilt[id] = true; }
}

const observer = new IntersectionObserver((entries) => {
  entries.forEach(e => { if (e.isIntersecting) buildChartIfVisible(e); });
}, { threshold: 0.3 });

['roe-chart', 'nim-chart', 'cti-chart', 'cet1-chart'].forEach(id => {
  observer.observe(document.getElementById(id));
});

// === NIM CLICKABLE BAR CHART ===
function buildNIMBarChart() {
  const container = document.getElementById('nim-chart');
  const cw = container.clientWidth || 700;
  const mob = cw < 500;
  const data = metrics.nim;
  const unit = '%';
  const margin = { top: 20, right: 30, bottom: 40, left: mob ? 45 : 55 };
  const width = Math.max(cw - margin.left - margin.right, 300);
  const height = mob ? 260 : 340;
  const svg = d3.select('#nim-chart').append('svg')
    .attr('viewBox', `0 0 ${width+margin.left+margin.right} ${height+margin.top+margin.bottom}`)
    .attr('preserveAspectRatio','xMidYMid meet').style('width','100%')
    .append('g').attr('transform',`translate(${margin.left},${margin.top})`);
  const x = d3.scaleBand().domain(banks.map(b=>b.code)).range([0,width]).padding(0.35);
  const y = d3.scaleLinear().domain([0,2.5]).range([height,0]);
  svg.append('g').attr('class','grid').call(d3.axisLeft(y).ticks(5).tickSize(-width).tickFormat(''));
  svg.selectAll('.nim-bar').data(data).join('rect')
    .attr('class','nim-bar').attr('x',(d,i)=>x(banks[i].code)).attr('width',x.bandwidth())
    .attr('y',height).attr('height',0).attr('rx',6).attr('fill',(d,i)=>banks[i].color)
    .on('mousemove',(e,d)=>{const i=data.indexOf(d);showTip(e,`<div class="tt-bank">${banks[i].name}</div><div class="tt-val">${d}${unit}</div><div style="font-size:0.7rem;color:var(--text-muted);margin-top:2px;">Click for waterfall breakdown</div>`);})
    .on('mouseleave',hideTip)
    .on('click',(e,d)=>{hideTip();showNIMWaterfall(data.indexOf(d));})
    .transition().duration(800).delay((d,i)=>i*100).ease(d3.easeCubicOut)
    .attr('y',d=>y(d)).attr('height',d=>height-y(d));

  svg.selectAll('.val-label').data(data).join('text').attr('class','val-label')
    .attr('x',(d,i)=>x(banks[i].code)+x.bandwidth()/2).attr('y',d=>y(d)-8)
    .attr('text-anchor','middle').attr('fill','#e2e8f0').attr('font-size',mob?'11px':'13px').attr('font-weight','600')
    .attr('opacity',0).text(d=>d+unit).transition().duration(600).delay((d,i)=>i*100+400).attr('opacity',1);

  const bestIdx=data.indexOf(Math.max(...data));
  svg.append('text').attr('x',x(banks[bestIdx].code)+x.bandwidth()/2).attr('y',y(data[bestIdx])-24)
    .attr('text-anchor','middle').attr('fill','#f59e0b').attr('font-size','14px').text('üëë')
    .attr('opacity',0).transition().delay(1000).duration(400).attr('opacity',1);

  svg.append('g').attr('class','axis').attr('transform',`translate(0,${height})`).call(d3.axisBottom(x).tickSize(0)).select('.domain').remove();
  svg.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(5).tickFormat(d=>d+unit)).select('.domain').remove();
}

// === NIM WATERFALL DATA ===
const nimWaterfallData = {
  CBA: {
    fy24:1.99,fy25:2.08,change:9,
    steps:[
      {label:'FY24 NIM',value:1.99,type:'start'},
      {label:'Replicating portfolio',value:0.06,type:'pos'},
      {label:'Capital earnings',value:0.04,type:'pos'},
      {label:'Deposit pricing',value:-0.02,type:'neg'},
      {label:'Home loan competition',value:-0.03,type:'neg'},
      {label:'Volume mix',value:0.02,type:'pos'},
      {label:'Other',value:0.02,type:'pos'},
      {label:'FY25 NIM',value:2.08,type:'total'}
    ],
    commentary:{title:'CBA NIM +9bps to 2.08% ‚Äî Hedging & Capital Drive Gains',body:'CBA\'s NIM rose 9bps from 1.99% to 2.08%, primarily driven by higher earnings on its replicating portfolio (+6bps) as hedges rolled onto higher rates, and increased capital earnings (+4bps). These tailwinds were partially offset by deposit pricing competition (-2bps) as customers shifted to higher-yielding term deposits, and home lending competition (-3bps). Favourable volume mix (+2bps) from growing business lending contributed the remainder.'}
  },
  NAB: {
    fy24:1.71,fy25:1.74,change:3,
    steps:[
      {label:'FY24 NIM',value:1.71,type:'start'},
      {label:'Markets & Treasury',value:0.02,type:'pos'},
      {label:'Replicating portfolio',value:0.03,type:'pos'},
      {label:'Deposit costs',value:-0.02,type:'neg'},
      {label:'Wholesale funding',value:-0.02,type:'neg'},
      {label:'Lending competition',value:-0.01,type:'neg'},
      {label:'Liquid assets',value:0.02,type:'pos'},
      {label:'Other',value:0.01,type:'pos'},
      {label:'FY25 NIM',value:1.74,type:'total'}
    ],
    commentary:{title:'NAB NIM +3bps to 1.74% ‚Äî M&T Income Masks Underlying Pressure',body:'NAB\'s reported NIM rose 3bps to 1.74%, but excluding a 2bps contribution from Markets & Treasury, NIM improved just 1bp. Higher replicating portfolio earnings (+3bps) and lower liquid asset costs (+2bps) provided support, but were offset by deposit cost pressures (-2bps), higher wholesale funding costs (-2bps), and lending competition (-1bp). NAB\'s pivot toward proprietary home lending (41% of drawdowns vs 38% in FY24) aims to improve margin economics.'}
  },
  ANZ: {
    fy24:1.60,fy25:1.55,change:-5,
    steps:[
      {label:'FY24 NIM',value:1.60,type:'start'},
      {label:'Suncorp integration',value:-0.04,type:'neg'},
      {label:'Mortgage competition',value:-0.03,type:'neg'},
      {label:'Deposit mix',value:-0.02,type:'neg'},
      {label:'Replicating portfolio',value:0.02,type:'pos'},
      {label:'Capital & other',value:0.02,type:'pos'},
      {label:'FY25 NIM',value:1.55,type:'total'}
    ],
    commentary:{title:'ANZ NIM -5bps to 1.55% ‚Äî Suncorp Drag & Mortgage Wars',body:'ANZ saw the steepest NIM decline among the majors, falling 5bps from 1.60% to 1.55%. The Suncorp Bank integration was the single largest headwind (-4bps), as the acquired book carried lower-margin mortgage assets. Intense mortgage competition weighed -3bps, and deposit mix shift to higher-cost term products added -2bps. Partially offsetting, replicating portfolio earnings (+2bps) and capital/other items (+2bps) provided some support.'}
  },
  WBC: {
    fy24:1.95,fy25:1.94,change:-1,
    steps:[
      {label:'FY24 NIM',value:1.95,type:'start'},
      {label:'Treasury & Markets',value:0.03,type:'pos'},
      {label:'Deposit repricing',value:-0.02,type:'neg'},
      {label:'Mortgage competition',value:-0.02,type:'neg'},
      {label:'Wholesale funding',value:-0.01,type:'neg'},
      {label:'Volume growth',value:0.01,type:'pos'},
      {label:'FY25 NIM',value:1.94,type:'total'}
    ],
    commentary:{title:'Westpac NIM -1bp to 1.94% ‚Äî Resilient Despite Headwinds',body:'Westpac\'s NIM proved remarkably resilient, declining just 1bp from 1.95% to 1.94%. Treasury & Markets contributed +3bps, while mortgage competition (-2bps) and deposit repricing (-2bps) were the primary drags. Higher wholesale funding costs added -1bp. Business lending growth of 15% provided a modest +1bp volume benefit. The sale of the $21.4bn RAMS portfolio will reshape the margin profile in FY26.'}
  },
  MQG: {
    fy24:1.72,fy25:1.80,change:8,
    steps:[
      {label:'FY24 NIM',value:1.72,type:'start'},
      {label:'Deposit growth',value:0.04,type:'pos'},
      {label:'Home loan volume',value:0.03,type:'pos'},
      {label:'Funding costs',value:-0.02,type:'neg'},
      {label:'Rate environment',value:0.02,type:'pos'},
      {label:'Other',value:0.01,type:'pos'},
      {label:'FY25 NIM',value:1.80,type:'total'}
    ],
    commentary:{title:'Macquarie BFS NIM +8bps to ~1.80% ‚Äî Deposit Surge Fuels Growth',body:'Macquarie\'s Banking & Financial Services division NIM expanded ~8bps to ~1.80%. The standout driver was deposit growth (+4bps), with total deposits surging 20% to $177.7bn via its digital-first savings platform. Home loan volume growth contributed +3bps, while the higher rate environment added +2bps. Higher wholesale funding costs (-2bps) were the primary offset.'}
  }
};

// === NIM WATERFALL CHART BUILDER ===
function buildWaterfallChart(bankCode) {
  const wf = nimWaterfallData[bankCode];
  const bankIdx = banks.findIndex(b=>b.code===bankCode);
  const bankColor = banks[bankIdx].color;
  const container = document.getElementById('nim-waterfall-chart');
  container.innerHTML = '';

  const cw = container.clientWidth || 700;
  const mob = cw < 500;
  const margin = {top:25,right:20,bottom:mob?95:90,left:mob?50:60};
  const width = Math.max(cw-margin.left-margin.right,300);
  const height = mob?280:360;

  const svg = d3.select('#nim-waterfall-chart').append('svg')
    .attr('viewBox',`0 0 ${width+margin.left+margin.right} ${height+margin.top+margin.bottom}`)
    .attr('preserveAspectRatio','xMidYMid meet').style('width','100%')
    .append('g').attr('transform',`translate(${margin.left},${margin.top})`);

  const steps = wf.steps;
  const labels = steps.map(s=>s.label);
  const x = d3.scaleBand().domain(labels).range([0,width]).padding(0.22);

  // Y axis starts from ~1% not 0 to zoom into the changes
  const yMin = 1.0;

  // Compute running totals ‚Äî use yMin as base for start/total bars
  let running = 0;
  const bars = steps.map(s=>{
    if(s.type==='start'){running=s.value;return{...s,y0:yMin,y1:s.value};}
    if(s.type==='total'){return{...s,y0:yMin,y1:s.value};}
    const prev=running;running+=s.value;
    return{...s,y0:Math.min(prev,running),y1:Math.max(prev,running)};
  });

  const allMaxes = bars.map(b=>b.y1);
  const yMax = Math.max(...allMaxes)+0.06;
  const y = d3.scaleLinear().domain([yMin,yMax]).range([height,0]);

  svg.append('g').attr('class','grid').call(d3.axisLeft(y).ticks(6).tickSize(-width).tickFormat(''));

  // Connector lines
  let connRunning = wf.fy24;
  for(let i=0;i<bars.length-1;i++){
    if(bars[i].type==='total') continue;
    const connY = bars[i].type==='start'?bars[i].y1:(bars[i].value>0?bars[i].y1:bars[i].y0);
    svg.append('line')
      .attr('x1',x(bars[i].label)+x.bandwidth()).attr('x2',x(bars[i+1].label))
      .attr('y1',y(connY)).attr('y2',y(connY))
      .attr('stroke','var(--border)').attr('stroke-dasharray','3,3').attr('stroke-width',1);
  }

  // Fix 5: Bars animate bottom-to-top
  svg.selectAll('.wf-bar').data(bars).join('rect')
    .attr('class','wf-bar')
    .attr('x',d=>x(d.label)).attr('width',x.bandwidth()).attr('rx',4)
    // Start from bottom of each bar's final position
    .attr('y',d=>y(d.y0)).attr('height',0)
    .attr('fill',d=>{
      // Fix 6: start and total bars use bank color
      if(d.type==='start'||d.type==='total') return bankColor;
      if(d.type==='pos') return 'var(--positive)';
      return 'var(--negative)';
    })
    .attr('opacity',d=>(d.type==='start')?0.55:0.9)
    .on('mousemove',(e,d)=>{
      let v=d.type==='start'||d.type==='total'?d.value.toFixed(2)+'%':(d.value>0?'+':'')+Math.round(d.value*100)+'bps';
      showTip(e,`<div class="tt-bank">${d.label}</div><div class="tt-val">${v}</div>`);
    })
    .on('mouseleave',hideTip)
    // Animate height growing upward from y0
    .transition().duration(600).delay((d,i)=>i*80).ease(d3.easeCubicOut)
    .attr('y',d=>y(d.y1))
    .attr('height',d=>Math.max(y(d.y0)-y(d.y1),2));

  // Value labels
  svg.selectAll('.wf-label').data(bars).join('text').attr('class','wf-label')
    .attr('x',d=>x(d.label)+x.bandwidth()/2)
    .attr('y',d=>{
      if(d.type==='neg') return y(d.y0)+16;
      return y(d.y1)-7;
    })
    .attr('text-anchor','middle')
    .attr('fill',d=>{
      if(d.type==='pos')return'var(--positive)';if(d.type==='neg')return'var(--negative)';return'#e2e8f0';
    })
    .attr('font-size',mob?'10px':'12px').attr('font-weight','600')
    .attr('opacity',0)
    .text(d=>{
      if(d.type==='start'||d.type==='total')return d.value.toFixed(2)+'%';
      return(d.value>0?'+':'')+Math.round(d.value*100)+'bps';
    })
    .transition().duration(400).delay((d,i)=>i*80+300).attr('opacity',1);

  // Fix 4: Larger x-axis font for desktop
  const xAxis = svg.append('g').attr('class','axis').attr('transform',`translate(0,${height})`)
    .call(d3.axisBottom(x).tickSize(0));
  xAxis.select('.domain').remove();
  xAxis.selectAll('text')
    .style('font-size',mob?'10px':'13px')
    .attr('dy','0.5em')
    .attr('transform','rotate(-30)')
    .style('text-anchor','end');

  svg.append('g').attr('class','axis')
    .call(d3.axisLeft(y).ticks(6).tickFormat(d=>d.toFixed(2)+'%'))
    .select('.domain').remove();

  // Show inline commentary below the chart
  const commEl = document.getElementById('waterfall-inline-commentary');
  document.getElementById('wf-inline-title').textContent = 'üìä ' + wf.commentary.title;
  document.getElementById('wf-inline-body').textContent = wf.commentary.body;
  commEl.style.display = 'block';
  commEl.style.opacity = '0';
  commEl.style.borderLeftColor = bankColor;
  commEl.style.transition = 'opacity 0.4s ease 0.3s';
  requestAnimationFrame(()=>{commEl.style.opacity='1';});
}

// === NIM VIEW TRANSITIONS ===
function showNIMWaterfall(bankIndex) {
  const bankCode = banks[bankIndex].code;
  const wf = nimWaterfallData[bankCode];
  const bankColor = banks[bankIndex].color;

  document.getElementById('waterfall-title').innerHTML = `<span style="color:${bankColor}">${banks[bankIndex].name}</span> ‚Äî NIM Waterfall`;
  document.getElementById('waterfall-subtitle').textContent = `FY24 ${wf.fy24.toFixed(2)}% ‚Üí FY25 ${wf.fy25.toFixed(2)}% (${wf.change>0?'+':''}${wf.change}bps)`;

  const barView = document.getElementById('nim-bar-view');
  const wfView = document.getElementById('nim-waterfall-view');

  barView.style.opacity='0';barView.style.transform='translateX(-30px)';

  setTimeout(()=>{
    barView.style.display='none';
    wfView.style.display='block';
    buildWaterfallChart(bankCode);
    requestAnimationFrame(()=>{wfView.style.opacity='1';wfView.style.transform='translateX(0)';});
  },400);
}

function hideNIMWaterfall() {
  const barView = document.getElementById('nim-bar-view');
  const wfView = document.getElementById('nim-waterfall-view');

  wfView.style.opacity='0';wfView.style.transform='translateX(30px)';

  setTimeout(()=>{
    wfView.style.display='none';
    document.getElementById('nim-waterfall-chart').innerHTML='';
    document.getElementById('waterfall-inline-commentary').style.display='none';
    barView.style.display='block';
    requestAnimationFrame(()=>{barView.style.opacity='1';barView.style.transform='translateX(0)';});
  },400);
}

document.getElementById('nim-back-btn').addEventListener('click', hideNIMWaterfall);

// === SCROLL FADE-IN FOR SECTIONS ===
const sectionObserver = new IntersectionObserver((entries) => {
  entries.forEach(e => {
    if (e.isIntersecting) {
      e.target.style.opacity = 1;
      e.target.style.transform = 'translateY(0)';
    }
  });
}, { threshold: 0.1 });

document.querySelectorAll('.section').forEach(s => {
  s.style.opacity = 0;
  s.style.transform = 'translateY(30px)';
  s.style.transition = 'opacity 0.7s ease, transform 0.7s ease';
  sectionObserver.observe(s);
});

// === THREE.JS GLOBE ===
(function initGlobe() {
  const canvas = document.getElementById('globe-canvas');
  const hero = document.getElementById('hero-section');
  if (!canvas || !hero) return;

  const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setClearColor(0x000000, 0);

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
  // Camera position set dynamically in resize()

  // Lighting ‚Äî warm gold tint to match the dashboard accent
  const ambient = new THREE.AmbientLight(0x2a2015, 0.7);
  scene.add(ambient);
  const dirLight = new THREE.DirectionalLight(0x8a7040, 0.8);
  dirLight.position.set(-3, 2, 4);
  scene.add(dirLight);
  const rimLight = new THREE.DirectionalLight(0x3a3020, 0.3);
  rimLight.position.set(3, -1, -2);
  scene.add(rimLight);

  // Simplified country outlines as [lon, lat] polylines
  // Australia outline (simplified)
  const australiaCoords = [
    [113.1,-26.1],[114.1,-26.3],[114.1,-25.8],[113.6,-24.3],[113.9,-22.5],
    [114.2,-22.3],[114.6,-21.8],[115.7,-21.5],[116.7,-20.7],[117.2,-20.7],
    [118.8,-20.3],[119.8,-20.0],[121.5,-19.6],[123.3,-17.3],[123.6,-17.1],
    [123.5,-16.6],[124.0,-16.4],[124.7,-15.4],[125.1,-15.0],[125.6,-14.2],
    [126.0,-14.0],[126.7,-14.2],[127.3,-14.1],[128.2,-14.8],[128.7,-14.9],
    [129.4,-14.4],[129.8,-14.6],[129.8,-13.6],[130.3,-13.3],[130.7,-12.7],
    [131.0,-12.5],[131.7,-12.2],[132.0,-12.1],[132.4,-12.2],[133.0,-12.0],
    [133.6,-12.2],[134.3,-12.0],[135.3,-12.3],[136.0,-12.4],[136.3,-12.0],
    [136.2,-12.4],[136.7,-12.8],[136.0,-13.5],[135.5,-14.6],[135.5,-14.9],
    [136.3,-15.5],[137.1,-15.9],[137.8,-16.2],[138.1,-16.7],[138.8,-16.8],
    [139.1,-17.1],[139.5,-17.3],[140.5,-17.6],[140.9,-17.9],[141.0,-16.1],
    [141.0,-12.8],[142.0,-10.9],[142.4,-10.7],[142.6,-10.7],[142.6,-10.9],
    [142.9,-11.8],[143.2,-12.2],[143.5,-13.0],[143.6,-14.0],[144.0,-14.4],
    [144.4,-14.5],[144.6,-14.2],[145.0,-14.9],[145.4,-15.1],[145.4,-16.3],
    [146.0,-17.0],[146.3,-18.0],[146.3,-18.8],[146.7,-19.1],[147.1,-19.4],
    [147.8,-19.7],[148.6,-20.2],[148.9,-20.5],[149.1,-21.0],[149.4,-21.8],
    [149.7,-22.3],[150.1,-22.2],[150.6,-22.4],[150.7,-23.5],[151.2,-23.8],
    [151.6,-24.0],[152.1,-24.6],[152.4,-25.0],[152.9,-25.5],[153.1,-26.1],
    [153.2,-27.2],[153.6,-28.2],[153.6,-28.7],[153.1,-30.3],[152.9,-31.0],
    [152.4,-32.0],[151.8,-32.9],[151.3,-33.6],[151.1,-34.0],[150.7,-35.0],
    [150.3,-35.5],[150.0,-35.9],[149.9,-37.0],[150.0,-37.3],[149.5,-37.7],
    [148.0,-37.6],[147.4,-38.2],[146.9,-38.7],[146.3,-39.0],[145.5,-38.9],
    [145.0,-38.4],[144.5,-38.1],[144.0,-38.0],[143.5,-38.5],[142.5,-38.4],
    [141.6,-38.4],[140.6,-38.0],[139.8,-37.0],[139.8,-36.6],[139.0,-35.7],
    [138.5,-35.0],[138.2,-34.4],[137.8,-33.6],[137.4,-34.2],[137.0,-34.7],
    [136.2,-35.1],[135.5,-35.0],[134.9,-33.8],[134.7,-33.3],[134.2,-33.2],
    [131.1,-31.5],[129.0,-31.6],[127.3,-32.3],[126.1,-32.2],[124.0,-33.0],
    [123.7,-33.9],[122.0,-33.9],[121.0,-33.8],[119.6,-34.0],[118.0,-33.7],
    [116.7,-33.5],[115.7,-33.3],[115.3,-33.6],[115.0,-34.0],[115.1,-33.5],
    [115.7,-32.7],[115.7,-31.8],[114.9,-30.6],[115.0,-29.5],[114.6,-28.7],
    [114.1,-27.3],[113.1,-26.1]
  ];

  // Tasmania outline (part of Australia ‚Äî styled the same gold)
  const tasmaniaCoords = [
    [145.0,-40.8],[145.5,-40.8],[146.0,-41.0],[146.3,-41.1],[146.8,-41.2],
    [147.3,-41.1],[147.7,-41.1],[148.0,-40.9],[148.3,-41.1],[148.3,-41.5],
    [148.2,-41.9],[148.0,-42.1],[147.9,-42.5],[147.8,-42.9],[148.0,-43.1],
    [148.2,-43.3],[148.3,-43.5],[147.8,-43.3],[147.3,-43.2],[146.9,-43.5],
    [146.1,-43.5],[145.7,-43.3],[145.3,-42.8],[145.0,-42.6],[144.7,-42.5],
    [144.7,-42.0],[144.8,-41.6],[145.0,-41.2],[145.0,-40.8]
  ];

  // No other country outlines ‚Äî only Australia highlighted

  // Equirectangular ‚Üí sphere position
  function lonLatToVec3(lon, lat, r) {
    const phi = (90 - lat) * Math.PI / 180;
    const theta = (lon + 180) * Math.PI / 180;
    return new THREE.Vector3(
      -r * Math.sin(phi) * Math.cos(theta),
       r * Math.cos(phi),
       r * Math.sin(phi) * Math.sin(theta)
    );
  }

  // Create line geometry from coordinate pairs
  function createLine(coords, color, linewidth, radius) {
    const points = coords.map(c => lonLatToVec3(c[0], c[1], radius));
    const geometry = new THREE.BufferGeometry().setFromPoints(points);
    const material = new THREE.LineBasicMaterial({ color, transparent: true, opacity: 0.5 });
    return new THREE.Line(geometry, material);
  }

  // Globe sphere (dark body)
  const globeGeo = new THREE.SphereGeometry(1, 64, 64);
  const globeMat = new THREE.MeshPhongMaterial({
    color: 0x0d1117,
    emissive: 0x08060a,
    specular: 0x28221a,
    shininess: 25,
    transparent: false,
  });
  const globe = new THREE.Mesh(globeGeo, globeMat);
  scene.add(globe);

  // Atmosphere ring (subtle warm gold glow matching title gradient)
  const atmosGeo = new THREE.SphereGeometry(1.02, 64, 64);
  const atmosMat = new THREE.ShaderMaterial({
    vertexShader: `
      varying vec3 vNormal;
      void main() {
        vNormal = normalize(normalMatrix * normal);
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }`,
    fragmentShader: `
      varying vec3 vNormal;
      void main() {
        float intensity = pow(0.62 - dot(vNormal, vec3(0.0, 0.0, 1.0)), 3.0);
        gl_FragColor = vec4(0.96, 0.62, 0.04, 1.0) * intensity * 0.3;
      }`,
    side: THREE.BackSide,
    blending: THREE.AdditiveBlending,
    transparent: true
  });
  const atmosphere = new THREE.Mesh(atmosGeo, atmosMat);
  scene.add(atmosphere);

  // Container for all lines (will rotate together)
  const linesGroup = new THREE.Group();
  scene.add(linesGroup);

  // Draw Australia highlighted in gold with fill effect
  // Australia mainland outline as bright gold line
  const ausLine = createLine(australiaCoords, 0xf5a623, 2, 1.003);
  ausLine.material.opacity = 0.9;
  linesGroup.add(ausLine);

  // Tasmania outline as bright gold line (same style as mainland)
  const tasLine = createLine(tasmaniaCoords, 0xf5a623, 2, 1.003);
  tasLine.material.opacity = 0.9;
  linesGroup.add(tasLine);

  // Create a filled Australia mesh using shape extrusion on the sphere
  // We'll use a triangulated mesh from the outline projected onto the sphere
  function createCountryFill(coords, color, radius) {
    // Create many points filling the interior by using a grid approach
    // First find bounding box
    let minLon = Infinity, maxLon = -Infinity, minLat = Infinity, maxLat = -Infinity;
    coords.forEach(c => {
      minLon = Math.min(minLon, c[0]); maxLon = Math.max(maxLon, c[0]);
      minLat = Math.min(minLat, c[1]); maxLat = Math.max(maxLat, c[1]);
    });

    // Point-in-polygon test (ray casting)
    function pointInPoly(x, y, poly) {
      let inside = false;
      for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
        const xi = poly[i][0], yi = poly[i][1];
        const xj = poly[j][0], yj = poly[j][1];
        if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
          inside = !inside;
        }
      }
      return inside;
    }

    // Generate triangulated mesh covering Australia
    const positions = [];
    const step = 0.8; // degree resolution
    const innerPoints = [];

    for (let lon = minLon; lon <= maxLon; lon += step) {
      for (let lat = minLat; lat <= maxLat; lat += step) {
        if (pointInPoly(lon, lat, coords)) {
          innerPoints.push([lon, lat]);
        }
      }
    }

    // Create small quads for each interior point
    const vertices = [];
    const hs = step * 0.55; // slight overlap
    innerPoints.forEach(([lon, lat]) => {
      const p1 = lonLatToVec3(lon - hs, lat - hs, radius);
      const p2 = lonLatToVec3(lon + hs, lat - hs, radius);
      const p3 = lonLatToVec3(lon + hs, lat + hs, radius);
      const p4 = lonLatToVec3(lon - hs, lat + hs, radius);
      // Two triangles per quad
      vertices.push(p1.x, p1.y, p1.z, p2.x, p2.y, p2.z, p3.x, p3.y, p3.z);
      vertices.push(p1.x, p1.y, p1.z, p3.x, p3.y, p3.z, p4.x, p4.y, p4.z);
    });

    const geom = new THREE.BufferGeometry();
    geom.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
    geom.computeVertexNormals();

    const mat = new THREE.MeshBasicMaterial({
      color: color,
      transparent: true,
      opacity: 0.85,
      side: THREE.DoubleSide
    });
    return new THREE.Mesh(geom, mat);
  }

  const ausFill = createCountryFill(australiaCoords, 0xf5a623, 1.004);
  linesGroup.add(ausFill);

  // Tasmania fill (same gold as mainland)
  const tasFill = createCountryFill(tasmaniaCoords, 0xf5a623, 1.004);
  linesGroup.add(tasFill);

  // Australia glow (larger slightly transparent fill behind)
  const ausGlow = createCountryFill(australiaCoords, 0xf5a623, 1.001);
  ausGlow.material.opacity = 0.25;
  linesGroup.add(ausGlow);

  // Tasmania glow
  const tasGlow = createCountryFill(tasmaniaCoords, 0xf5a623, 1.001);
  tasGlow.material.opacity = 0.25;
  linesGroup.add(tasGlow);

  // Initial rotation to center Australia facing the camera
  // In Three.js SphereGeometry: lon=0 is at -Z, so to bring lon to face +Z camera:
  // rotY = -(lon * PI/180) + PI (negate because Y-rotation is counterclockwise)
  // rotX = lat * PI/180 (positive lat = north, negative = south, tilt forward to show southern hemisphere)
  const targetLon = 60;  // Australia center longitude
  const targetLat = -25;  // Australia center latitude
  const initRotY = -(targetLon * Math.PI / 180) + Math.PI;
  const initRotX = targetLat * Math.PI / 180; // negative tilts south toward camera

  globe.rotation.y = initRotY;
  globe.rotation.x = initRotX;
  atmosphere.rotation.y = initRotY;
  atmosphere.rotation.x = initRotX;
  linesGroup.rotation.y = initRotY;
  linesGroup.rotation.x = initRotX;

  // Sizing ‚Äî globe scales dynamically with viewport
  function resize() {
    const w = hero.clientWidth;
    const h = hero.clientHeight;
    renderer.setSize(w, h);
    camera.aspect = w / h;

    // Dynamic camera distance: globe fills ~60% of viewport on desktop, ~45% on mobile
    // Larger viewport ‚Üí closer camera ‚Üí bigger globe
    const minWidth = 320, maxWidth = 1400;
    const minZ = 3.2, maxZ = 5.2; // closer = bigger globe, further = smaller
    const t = Math.max(0, Math.min(1, (w - minWidth) / (maxWidth - minWidth)));
    // Ease: starts small on mobile, grows on desktop
    const cameraZ = maxZ - t * (maxZ - minZ);
    camera.position.set(0, -0.15, cameraZ);
    camera.lookAt(0, -0.15, 0);

    camera.updateProjectionMatrix();
  }
  resize();
  window.addEventListener('resize', resize);

  // Scroll-driven rotation
  let scrollRotation = 0;
  let currentScrollRotation = 0;
  window.addEventListener('scroll', () => {
    const heroRect = hero.getBoundingClientRect();
    const heroH = hero.clientHeight;
    // Only act while hero is visible
    if (heroRect.bottom > 0 && heroRect.top < window.innerHeight) {
      const progress = Math.max(0, Math.min(1, -heroRect.top / heroH));
      scrollRotation = progress * 0.6; // Rotate up to ~35¬∞ on scroll
    }
  }, { passive: true });

  // Subtle continuous idle rotation + glow pulse
  let time = 0;
  function animate() {
    requestAnimationFrame(animate);
    time += 0.005;

    // Smooth lerp toward scroll target
    currentScrollRotation += (scrollRotation - currentScrollRotation) * 0.08;

    // Idle rotation (very slow continuous spin)
    const idleRot = time * 0.03;

    const ry = initRotY + currentScrollRotation + idleRot;
    const rx = initRotX + currentScrollRotation * 0.15;

    globe.rotation.y = ry;
    globe.rotation.x = rx;
    atmosphere.rotation.y = ry;
    atmosphere.rotation.x = rx;
    linesGroup.rotation.y = ry;
    linesGroup.rotation.x = rx;

    // Subtle glow pulse on Australia + Tasmania
    const pulse = 0.75 + Math.sin(time * 2) * 0.15;
    ausFill.material.opacity = pulse;
    tasFill.material.opacity = pulse;

    renderer.render(scene, camera);
  }
  animate();
})();
</script>
</body>
</html>
